<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêang Offline - Notes App</title>
    <link rel="stylesheet" href="/css/offline.css">
</head>
<body class="offline-page">
    <div class="container">
        <!-- <div class="icon">üìù</div> -->
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHBhdGggZD0iTTUwIDEwQzI3LjkwODYgMTAgMTAgMjcuOTA4NiAxMCA1MEMxMCA3Mi4wOTE0IDI3LjkwODYgOTAgNTAgOTBDNzIuMDkxNCA5MCA5MCA3Mi4wOTE0IDkwIDUwQzkwIDI3LjkwODYgNzIuMDkxNCAxMCA1MCAxMFoiIHN0cm9rZT0iIzRhOTBlMiIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgPHBhdGggZD0iTTY1IDQ1TDUwIDYwTDM1IDQ1IiBzdHJva2U9IiM0YTkwZTIiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CiAgPHBhdGggZD0iTTUwIDMwVjU1IiBzdHJva2U9IiM0YTkwZTIiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=" class="offline-icon" alt="Offline">
        
        <h1>Kh√¥ng c√≥ Internet</h1>
        <p>B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô ngo·∫°i tuy·∫øn. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i.</p>
        
        <div class="error-message" id="error-message">
            Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.
        </div>
        
        <button class="btn try-again" id="try-again">Th·ª≠ l·∫°i</button>
        
        <div class="troubleshooting">
            <h3>H√£y th·ª≠:</h3>
            <ul>
                <li>Ki·ªÉm tra c√°p m·∫°ng, modem v√† b·ªô ƒë·ªãnh tuy·∫øn</li>
                <li>K·∫øt n·ªëi l·∫°i v·ªõi Wi-Fi</li>
                <li>Ki·ªÉm tra thi·∫øt l·∫≠p m·∫°ng c·ªßa b·∫°n</li>
            </ul>
        </div>
        
        <div class="notes-container" id="offline-notes">
            <!-- C√°c ghi ch√∫ s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y b·∫±ng JavaScript -->
            <p id="no-notes" style="text-align: center; display: none;">Kh√¥ng c√≥ ghi ch√∫ n√†o ƒë∆∞·ª£c l∆∞u trong b·ªô nh·ªõ c·ª•c b·ªô.</p>
        </div>
    </div>

    <script>
        // Khi trang t·∫£i xong, hi·ªÉn th·ªã c√°c ghi ch√∫ ƒë√£ ƒë∆∞·ª£c l∆∞u trong IndexedDB
        document.addEventListener('DOMContentLoaded', () => {
            const notesContainer = document.getElementById('offline-notes');
            const noNotesMessage = document.getElementById('no-notes');
            const errorMessage = document.getElementById('error-message');
            
            // Ki·ªÉm tra h·ªó tr·ª£ IndexedDB
            if (!window.indexedDB) {
                errorMessage.textContent = 'Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ l∆∞u tr·ªØ offline.';
                errorMessage.style.display = 'block';
                return;
            }
            
            // M·ªü k·∫øt n·ªëi ƒë·∫øn IndexedDB
            let request;
            try {
                request = indexedDB.open('notes-offline-db', 1);
            } catch (e) {
                errorMessage.textContent = 'Kh√¥ng th·ªÉ m·ªü c∆° s·ªü d·ªØ li·ªáu offline: ' + e.message;
                errorMessage.style.display = 'block';
                return;
            }
            
            request.onerror = (event) => {
                console.error('L·ªói khi m·ªü IndexedDB', event);
                errorMessage.textContent = 'Kh√¥ng th·ªÉ truy c·∫≠p d·ªØ li·ªáu offline.';
                errorMessage.style.display = 'block';
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                // T·∫°o c√°c object stores n·∫øu ch∆∞a t·ªìn t·∫°i
                if (!db.objectStoreNames.contains('notes')) {
                    const notesStore = db.createObjectStore('notes', { keyPath: 'id' });
                    notesStore.createIndex('user_id', 'user_id', { unique: false });
                    notesStore.createIndex('updated_at', 'updated_at', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('pending-operations')) {
                    const pendingStore = db.createObjectStore('pending-operations', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    pendingStore.createIndex('timestamp', 'timestamp', { unique: false });
                    pendingStore.createIndex('operation', 'operation', { unique: false });
                }
            };
            
            request.onsuccess = (event) => {
                try {
                    const db = event.target.result;
                    const transaction = db.transaction(['notes'], 'readonly');
                    const objectStore = transaction.objectStore('notes');
                    const notes = [];
                    
                    objectStore.openCursor().onsuccess = (event) => {
                        const cursor = event.target.result;
                        
                        if (cursor) {
                            notes.push(cursor.value);
                            cursor.continue();
                        } else {
                            // Hi·ªÉn th·ªã c√°c ghi ch√∫
                            if (notes.length > 0) {
                                // S·∫Øp x·∫øp theo th·ªùi gian c·∫≠p nh·∫≠t gi·∫£m d·∫ßn (m·ªõi nh·∫•t l√™n ƒë·∫ßu)
                                notes.sort((a, b) => {
                                    return new Date(b.updated_at) - new Date(a.updated_at);
                                });
                                
                                notes.forEach(note => {
                                    const noteCard = document.createElement('div');
                                    noteCard.className = 'note-card';
                                    noteCard.style.backgroundColor = note.color || '#fff9c4';
                                    
                                    const title = document.createElement('div');
                                    title.className = 'note-title';
                                    title.textContent = note.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
                                    
                                    const content = document.createElement('div');
                                    content.className = 'note-content';
                                    // Gi·ªõi h·∫°n n·ªôi dung hi·ªÉn th·ªã ƒë·ªÉ tr√°nh qu√° d√†i
                                    content.textContent = note.content 
                                        ? (note.content.length > 150 
                                            ? note.content.substring(0, 150) + '...' 
                                            : note.content)
                                        : 'Kh√¥ng c√≥ n·ªôi dung';
                                    
                                    noteCard.appendChild(title);
                                    noteCard.appendChild(content);
                                    notesContainer.appendChild(noteCard);
                                });
                            } else {
                                noNotesMessage.style.display = 'block';
                            }
                        }
                    };
                } catch (e) {
                    console.error('L·ªói khi truy c·∫≠p d·ªØ li·ªáu:', e);
                    errorMessage.textContent = 'L·ªói khi truy c·∫≠p d·ªØ li·ªáu: ' + e.message;
                    errorMessage.style.display = 'block';
                }
            };
            
            // Button th·ª≠ l·∫°i
            document.getElementById('try-again').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.reload();
            });
            
            // Ki·ªÉm tra k·∫øt n·ªëi ƒë·ªãnh k·ª≥
            function checkOnlineStatus() {
                if (navigator.onLine) {
                    window.location.href = '/';
                }
            }
            
            // Ki·ªÉm tra m·ªói 5 gi√¢y
            setInterval(checkOnlineStatus, 5000);
            
            // Th√™m s·ª± ki·ªán khi tr·ªü l·∫°i online
            window.addEventListener('online', () => {
                console.log('ƒê√£ k·∫øt n·ªëi l·∫°i internet!');
                window.location.href = '/';
            });
        });
    </script>
</body>
</html> 