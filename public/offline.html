<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒêang Offline - Notes App</title>
    <link rel="stylesheet" href="/css/offline.css">
</head>
<body class="offline-page">
    <div class="container">
        <!-- <div class="icon">üìù</div> -->
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgPHBhdGggZD0iTTUwIDEwQzI3LjkwODYgMTAgMTAgMjcuOTA4NiAxMCA1MEMxMCA3Mi4wOTE0IDI3LjkwODYgOTAgNTAgOTBDNzIuMDkxNCA5MCA5MCA3Mi4wOTE0IDkwIDUwQzkwIDI3LjkwODYgNzIuMDkxNCAxMCA1MCAxMFoiIHN0cm9rZT0iIzRhOTBlMiIgc3Ryb2tlLXdpZHRoPSI0Ii8+CiAgPHBhdGggZD0iTTY1IDQ1TDUwIDYwTDM1IDQ1IiBzdHJva2U9IiM0YTkwZTIiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+CiAgPHBhdGggZD0iTTUwIDMwVjU1IiBzdHJva2U9IiM0YTkwZTIiIHN0cm9rZS13aWR0aD0iNCIgc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIi8+Cjwvc3ZnPgo=" class="offline-icon" alt="Offline">
        
        <h1>Kh√¥ng c√≥ Internet</h1>
        <p>B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô ngo·∫°i tuy·∫øn. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet v√† th·ª≠ l·∫°i.</p>
        
        <div class="error-message" id="error-message">
            Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn m√°y ch·ªß. Vui l√≤ng th·ª≠ l·∫°i sau.
        </div>
        
        <button class="btn try-again" id="try-again">Th·ª≠ l·∫°i</button>
        
        <div class="troubleshooting">
            <h3>H√£y th·ª≠:</h3>
            <ul>
                <li>Ki·ªÉm tra c√°p m·∫°ng, modem v√† b·ªô ƒë·ªãnh tuy·∫øn</li>
                <li>K·∫øt n·ªëi l·∫°i v·ªõi Wi-Fi</li>
                <li>Ki·ªÉm tra thi·∫øt l·∫≠p m·∫°ng c·ªßa b·∫°n</li>
            </ul>
        </div>
        
        <!-- View Controls -->
        <div class="view-controls">
            <div>
                <h4 style="margin: 0;">C√°c ghi ch√∫ ƒë√£ l∆∞u offline</h4>
            </div>
            <div class="view-toggle">
                <button id="grid-view-btn" class="active">Grid</button>
                <button id="list-view-btn">List</button>
            </div>
        </div>
        
        <div class="notes-container" id="offline-notes">
            <div id="grid-view" class="grid-view">
                <!-- Grid view notes will be added here -->
            </div>
            
            <div id="list-view" class="list-view" style="display:none;">
                <!-- List view notes will be added here -->
            </div>
            
            <p id="no-notes" style="text-align: center; display: none;">Kh√¥ng c√≥ ghi ch√∫ n√†o ƒë∆∞·ª£c l∆∞u trong b·ªô nh·ªõ c·ª•c b·ªô.</p>
        </div>
    </div>

    <script>
        // Khi trang t·∫£i xong, hi·ªÉn th·ªã c√°c ghi ch√∫ ƒë√£ ƒë∆∞·ª£c l∆∞u trong IndexedDB
        document.addEventListener('DOMContentLoaded', () => {
            const gridView = document.getElementById('grid-view');
            const listView = document.getElementById('list-view');
            const gridViewBtn = document.getElementById('grid-view-btn');
            const listViewBtn = document.getElementById('list-view-btn');
            const noNotesMessage = document.getElementById('no-notes');
            const errorMessage = document.getElementById('error-message');
            
            // Chuy·ªÉn ƒë·ªïi gi·ªØa ch·∫ø ƒë·ªô xem Grid v√† List
            gridViewBtn.addEventListener('click', () => {
                gridView.style.display = 'grid';
                listView.style.display = 'none';
                gridViewBtn.classList.add('active');
                listViewBtn.classList.remove('active');
            });
            
            listViewBtn.addEventListener('click', () => {
                gridView.style.display = 'none';
                listView.style.display = 'block';
                listViewBtn.classList.add('active');
                gridViewBtn.classList.remove('active');
            });
            
            // Ki·ªÉm tra h·ªó tr·ª£ IndexedDB
            if (!window.indexedDB) {
                errorMessage.textContent = 'Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ l∆∞u tr·ªØ offline.';
                errorMessage.style.display = 'block';
                return;
            }
            
            // M·ªü k·∫øt n·ªëi ƒë·∫øn IndexedDB
            let request;
            try {
                request = indexedDB.open('notes-offline-db', 1);
            } catch (e) {
                errorMessage.textContent = 'Kh√¥ng th·ªÉ m·ªü c∆° s·ªü d·ªØ li·ªáu offline: ' + e.message;
                errorMessage.style.display = 'block';
                return;
            }
            
            request.onerror = (event) => {
                console.error('L·ªói khi m·ªü IndexedDB', event);
                errorMessage.textContent = 'Kh√¥ng th·ªÉ truy c·∫≠p d·ªØ li·ªáu offline.';
                errorMessage.style.display = 'block';
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                // T·∫°o c√°c object stores n·∫øu ch∆∞a t·ªìn t·∫°i
                if (!db.objectStoreNames.contains('notes')) {
                    const notesStore = db.createObjectStore('notes', { keyPath: 'id' });
                    notesStore.createIndex('user_id', 'user_id', { unique: false });
                    notesStore.createIndex('updated_at', 'updated_at', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('pending-operations')) {
                    const pendingStore = db.createObjectStore('pending-operations', { 
                        keyPath: 'id', 
                        autoIncrement: true 
                    });
                    pendingStore.createIndex('timestamp', 'timestamp', { unique: false });
                    pendingStore.createIndex('operation', 'operation', { unique: false });
                }
            };
            
            request.onsuccess = (event) => {
                try {
                    const db = event.target.result;
                    const transaction = db.transaction(['notes'], 'readonly');
                    const objectStore = transaction.objectStore('notes');
                    const notes = [];
                    
                    objectStore.openCursor().onsuccess = (event) => {
                        const cursor = event.target.result;
                        
                        if (cursor) {
                            notes.push(cursor.value);
                            cursor.continue();
                        } else {
                            // Hi·ªÉn th·ªã c√°c ghi ch√∫
                            if (notes.length > 0) {
                                // S·∫Øp x·∫øp theo th·ªùi gian c·∫≠p nh·∫≠t gi·∫£m d·∫ßn (m·ªõi nh·∫•t l√™n ƒë·∫ßu)
                                notes.sort((a, b) => {
                                    return new Date(b.updated_at) - new Date(a.updated_at);
                                });
                                
                                // Hi·ªÉn th·ªã ghi ch√∫ trong c·∫£ hai ch·∫ø ƒë·ªô xem
                                displayNotes(notes);
                            } else {
                                noNotesMessage.style.display = 'block';
                            }
                        }
                    };
                } catch (e) {
                    console.error('L·ªói khi truy c·∫≠p d·ªØ li·ªáu:', e);
                    errorMessage.textContent = 'L·ªói khi truy c·∫≠p d·ªØ li·ªáu: ' + e.message;
                    errorMessage.style.display = 'block';
                }
            };
            
            // Hi·ªÉn th·ªã ghi ch√∫ trong c·∫£ Grid View v√† List View
            function displayNotes(notes) {
                notes.forEach(note => {
                    // T·∫°o Grid View Note
                    const gridNoteCard = createGridNoteCard(note);
                    gridView.appendChild(gridNoteCard);
                    
                    // T·∫°o List View Note
                    const listNoteCard = createListNoteCard(note);
                    listView.appendChild(listNoteCard);
                });
            }
            
            // T·∫°o card cho Grid View
            function createGridNoteCard(note) {
                const noteCard = document.createElement('div');
                noteCard.className = 'note-card';
                noteCard.style.backgroundColor = note.color || '#fff9c4';
                
                const title = document.createElement('div');
                title.className = 'note-title';
                title.textContent = note.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
                
                const content = document.createElement('div');
                content.className = 'note-content';
                content.textContent = note.content 
                    ? (note.content.length > 150 
                        ? note.content.substring(0, 150) + '...' 
                        : note.content)
                    : 'Kh√¥ng c√≥ n·ªôi dung';
                
                // T·∫°o container cho c√°c n√∫t
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'note-buttons';
                
                // Th√™m c√°c n√∫t t∆∞∆°ng t√°c
                const buttons = createNoteButtons();
                buttons.forEach(button => buttonsContainer.appendChild(button));
                
                noteCard.appendChild(title);
                noteCard.appendChild(content);
                noteCard.appendChild(buttonsContainer);
                
                return noteCard;
            }
            
            // T·∫°o card cho List View
            function createListNoteCard(note) {
                const noteCard = document.createElement('div');
                noteCard.className = 'note-card';
                noteCard.style.backgroundColor = note.color || '#fff9c4';
                
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'note-content-wrapper';
                
                const title = document.createElement('div');
                title.className = 'note-title';
                title.textContent = note.title || 'Kh√¥ng c√≥ ti√™u ƒë·ªÅ';
                
                const content = document.createElement('div');
                content.className = 'note-content';
                content.textContent = note.content 
                    ? (note.content.length > 150 
                        ? note.content.substring(0, 150) + '...' 
                        : note.content)
                    : 'Kh√¥ng c√≥ n·ªôi dung';
                
                contentWrapper.appendChild(title);
                contentWrapper.appendChild(content);
                
                // T·∫°o container cho c√°c n√∫t
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'note-buttons';
                
                // Th√™m c√°c n√∫t t∆∞∆°ng t√°c
                const buttons = createNoteButtons();
                buttons.forEach(button => buttonsContainer.appendChild(button));
                
                noteCard.appendChild(contentWrapper);
                noteCard.appendChild(buttonsContainer);
                
                return noteCard;
            }
            
            // T·∫°o c√°c n√∫t cho ghi ch√∫
            function createNoteButtons() {
                // N√∫t Pin
                const pinButton = document.createElement('button');
                pinButton.className = 'note-button pin-button';
                pinButton.textContent = 'Pin';
                pinButton.disabled = true; // V√¥ hi·ªáu h√≥a trong ch·∫ø ƒë·ªô offline
                
                // N√∫t Xem
                const viewButton = document.createElement('button');
                viewButton.className = 'note-button view-button';
                viewButton.textContent = 'Xem';
                viewButton.disabled = true; // V√¥ hi·ªáu h√≥a trong ch·∫ø ƒë·ªô offline
                
                // N√∫t Ch·ªânh s·ª≠a
                const editButton = document.createElement('button');
                editButton.className = 'note-button edit-button';
                editButton.textContent = 'Ch·ªânh s·ª≠a';
                editButton.disabled = true; // V√¥ hi·ªáu h√≥a trong ch·∫ø ƒë·ªô offline
                
                // N√∫t Nh√£n
                const labelsButton = document.createElement('button');
                labelsButton.className = 'note-button labels-button';
                labelsButton.textContent = 'Nh√£n';
                labelsButton.disabled = true; // V√¥ hi·ªáu h√≥a trong ch·∫ø ƒë·ªô offline
                
                // N√∫t X√≥a
                const deleteButton = document.createElement('button');
                deleteButton.className = 'note-button delete-button';
                deleteButton.textContent = 'X√≥a';
                deleteButton.disabled = true; // V√¥ hi·ªáu h√≥a trong ch·∫ø ƒë·ªô offline
                
                return [pinButton, viewButton, editButton, labelsButton, deleteButton];
            }
            
            // Button th·ª≠ l·∫°i
            document.getElementById('try-again').addEventListener('click', (e) => {
                e.preventDefault();
                window.location.reload();
            });
            
            // Ki·ªÉm tra k·∫øt n·ªëi ƒë·ªãnh k·ª≥
            function checkOnlineStatus() {
                if (navigator.onLine) {
                    window.location.href = '/';
                }
            }
            
            // Ki·ªÉm tra m·ªói 5 gi√¢y
            setInterval(checkOnlineStatus, 5000);
            
            // Th√™m s·ª± ki·ªán khi tr·ªü l·∫°i online
            window.addEventListener('online', () => {
                console.log('ƒê√£ k·∫øt n·ªëi l·∫°i internet!');
                window.location.href = '/';
            });
        });
    </script>
</body>
</html> 